+++
title = 'Rax2Taro ï½œ ä»é›¶å®ç°ä¸€ä¸ªæ¡†æ¶ç¼–è¯‘å™¨'
date = 2024-04-16T20:06:23+08:00
draft = false # true è‰ç¨¿ä¸å±•ç¤º ï½œ false æ­£å¼ç¨¿å±•ç¤º
+++

![æˆªå±2024-03-05 17.30.57.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/74174dac9f6d4d1ebcf08ef5cfefe81d~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1722&h=958&s=752092&e=png&b=111419)

**Rax2Taro**ï¼š[ç‚¹å‡»æŸ¥çœ‹ Github åœ°å€](https://github.com/Trade-Offf/Rax2Taro?tab=readme-ov-file)

# ä¸€ã€å‰ç½®èƒŒæ™¯

ç¬”è€…æ—¥å¸¸ä½¿ç”¨ Rax æ¡†æ¶å¼€å‘å‰ç«¯éœ€æ±‚ã€‚ä½†éšç€ä¸šåŠ¡æ‰©å±•ï¼Œæˆ‘é¢ä¸´ä¸€ä¸ªå¤´ç—›çš„éœ€æ±‚ï¼šå°†ç°æœ‰çš„ Rax ç»„ä»¶é€‚é…ä¸º Taro ç»„ä»¶ï¼Œä»¥å®ç°ä¸€äº›ç‰¹å®šå•†ä¸šåœºæ™¯çš„è·¨å¹³å°åŠŸèƒ½ã€‚

è¿™ä¸€éœ€æ±‚å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š

- **æ–°åŠŸèƒ½å¼€å‘** - åœ¨ Taro æ¡†æ¶ä¸­å®ç°ï¼Œç¡®ä¿å¤šç«¯å…¼å®¹æ€§ã€‚
- **æ—§åŠŸèƒ½å¤ç”¨** - å°†ç°æœ‰ Rax ç»„ä»¶è½¬æ¢ä¸º Taroï¼Œé¿å…é‡å†™ã€‚

é‡å†™ç»„ä»¶æˆæœ¬é«˜æ˜‚ï¼Œç‰¹åˆ«æ˜¯å¯¹äºç¼ºä¹æ–‡æ¡£å’ŒåŸå¼€å‘è€…ä¸åœ¨çš„æ—§ç»„ä»¶ã€‚å› æ­¤æˆ‘éœ€è¦ä¸€ç§è‡ªåŠ¨åŒ–å·¥å…·ï¼Œèƒ½å¤Ÿè½»æ¾åœ°**ä¸€é”®å¼**å°† Rax ç»„ä»¶è½¬åŒ–ä¸º Taro ç»„ä»¶ï¼Œå‡å°‘å·¥ä½œé‡ï¼ŒåŠ å¿«å¼€å‘è¿›ç¨‹ã€‚

æœ¬ç¯‡åšå®¢å†…å®¹ï¼Œå°†æ¢è®¨æ„å»ºä¸€ä¸ªä» Rax è½¬æ¢åˆ° Taro çš„ç¼–è¯‘å™¨ï¼Œä»é›¶å¼€å§‹å®ç°ç»„ä»¶çº§è½¬æ¢ã€‚

> ã€Œ ææƒ§é€šå¸¸æºè‡ªæœªçŸ¥ï¼Œä½ ææƒ§çš„ä¸æ˜¯é€ è½®å­ï¼Œä½ ææƒ§çš„æ˜¯ä½ ä»æ¥æ²¡é€ è¿‡è½®å­ ã€

ä½œä¸ºå‰ç«¯åŒå­¦ï¼Œå¦‚æœé‡åˆ°è¿™ç§å·¥ä½œå¯èƒ½ä¼šæ±—æµæµƒèƒŒã€‚

ä½†ä¸è¦æ‹…å¿ƒï¼Œåªè¦æˆ‘ä»¬æŠŠç›®æ ‡æ‹†è§£åˆ°è¶³å¤Ÿæ¸…æ™°ã€è¶³å¤Ÿç»†åŒ–ï¼Œä¸€åˆ‡å›°éš¾éƒ½æ˜¯çº¸è€è™ã€‚

# äºŒã€ç¼–è¯‘å™¨

ç¼–è¯‘å™¨æ˜¯ä¸ªå®½æ³›çš„æ¦‚å¿µï¼Œæœ€åˆæ˜¯æŒ‡å°†**é«˜çº§è¯­è¨€**è½¬æ¢ä¸ºè®¡ç®—æœºèƒ½è¯†åˆ«çš„**æ±‡ç¼–/æœºå™¨è¯­è¨€**çš„å·¥å…·ã€‚

ä¸ªäººç†è§£ï¼šç¼–è¯‘å™¨æœ¬è´¨æ˜¯ä¸ªä» A è½¬æ¢çš„ B çš„ç¿»è¯‘å·¥å…· ï¼ˆå¦‚æœ‰ä¸å¦¥ï¼Œè¿˜åŸè¯„è®ºåŒºæŒ‡æ­£ ğŸ¤ï¼‰

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4555f984aba24ae0a690f5bb4d2cf7ab~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1252&h=186&s=15269&e=jpg&b=ffffff)

ä½†æ˜¯ç¼–è¯‘å™¨çš„ç¿»è¯‘è¿‡ç¨‹ä¸æ˜¯ç®€å•çš„ç¿»è¯‘ï¼Œé€šå¸¸æ¶‰åŠåˆ°å¤šä¸ªæ­¥éª¤ï¼ˆè¯æ³•ã€è¯­æ³•ã€è¯­ä¹‰åˆ†æã€ä¸­é—´ä»£ç ç”Ÿæˆç­‰ï¼‰ã€‚è¯¦ç»†çŸ¥è¯†ç‚¹ä¸èµ˜è¿°äº†ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹è¯·ç¿»é˜…[ã€Šç¼–è¯‘åŸç†ã€‹](https://book.douban.com/subject/3296317/)ã€‚

## 01 | Babelï¼šJavaScript ç¼–è¯‘å™¨

æˆ‘ä»¬ä»¥æ—¥å¸¸å¼€å‘ä¸­ï¼Œæ¥è§¦æœ€å¤šçš„ JavaScript ç¼–è¯‘å™¨ [Babel](https://babeljs.io/) ä¸ºä¾‹ï¼Œäº†è§£ç¼–è¯‘å™¨å·¥ä½œé€»è¾‘ï¼Œè¿™é‡Œåªä»‹ç» Babel åŸºæœ¬æµç¨‹ã€‚æ›´å¤šè¯¦ç»†å†…å®¹å¯ä»¥çœ‹ä»¥ä¸‹ Github å®˜æ–¹æ–‡æ¡£ï¼š[Babel æ’ä»¶æ‰‹å†Œ](https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/plugin-handbook.md)

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/17f4c01224db4d77bb2add4d54934e5e~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2326&h=813&s=84060&e=jpg&b=fefefe)

<p align=center>Babel å·¥ä½œæµç¨‹</p>

## 02 | åŸºæœ¬ç”¨æ³•

è¿™é‡Œä»¥å°† `const a = 1` è½¬æ¢æˆ ` var a = 1` ä¸ºä¾‹ï¼Œçœ‹ä¸‹ Babel æ˜¯å¦‚ä½•å·¥ä½œçš„

### i. è§£æï¼ˆparseï¼‰æˆæŠ½è±¡è¯­æ³•æ ‘ AST

> **æŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstract Syntax Treeï¼‰**ï¼šæœ¬è´¨æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå®ƒä»¥æ ‘çŠ¶çš„å½¢å¼è¡¨ç°ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•ç»“æ„ï¼Œæ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ç§ç»“æ„ã€‚

Babel æä¾›äº† [@babel/parser](https://babeljs.io/docs/babel-parser) å°†ä»£ç è§£ææˆ ASTã€‚ è¿™ä¸€æ­¥ä¸»è¦åšä¸¤ä»¶äº‹ï¼š

- **è¯æ³•åˆ†æ**ï¼šæŠŠä»£ç è½¬æ¢ä¸ºä»¤ç‰Œæµï¼ˆtokens flowï¼šè§£æçš„ä¸­é—´äº§ç‰©ï¼Œä¸ç”¨ç®¡ï¼‰
- **è¯­æ³•åˆ†æ**ï¼šå†æŠŠæ¯ä¸ª token è½¬æ¢ä¸º AST ç»“æ„

```JS
const parse = require('@babel/parser').parse;

const ast = parse('const a = 1');
```

### ii. è½¬æ¢ï¼ˆtransformï¼‰AST

Babel æä¾›äº† [@babel/traverse](https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fnext%2Fbabel-traverse) å¯¹è§£æåçš„ AST è¿›è¡Œå¤„ç†ã€‚

è½¬æ¢æ¥æ”¶ AST å¹¶å¯¹å…¶éå†ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­å¯¹èŠ‚ç‚¹è¿›è¡Œå¢åˆ æ”¹æŸ¥ï¼Œæ˜¯ Babel ç¼–è¯‘å™¨æœ€æ ¸å¿ƒçš„è¿‡ç¨‹ã€‚

`traverse()`èƒ½å¤Ÿæ¥æ”¶ ast ä»¥åŠ visitor ä¸¤ä¸ªå‚æ•°ï¼š

- **ast** æ˜¯ä¸Šä¸€æ­¥è§£æå¾—åˆ°çš„æŠ½è±¡è¯­æ³•æ ‘ã€‚
- **visitor** æä¾›è®¿é—®ä¸åŒèŠ‚ç‚¹çš„èƒ½åŠ›ï¼Œå½“éå†åˆ°ä¸€ä¸ªåŒ¹é…çš„èŠ‚ç‚¹æ—¶ï¼Œèƒ½å¤Ÿè°ƒç”¨å…·ä½“æ–¹æ³•å¯¹èŠ‚ç‚¹è¿›è¡Œå¤„ç†ã€‚

```JS
const t = require('@babel/types');
const traverse = require('@babel/traverse').default;

traverse(ast, {
  VariableDeclaration: function(path) {
    if (path.node.kind === 'const') {
      path.replaceWith(
        t.variableDeclaration('var', path.node.declarations) //æ›¿æ¢æˆ var
      );
    }
    path.skip();
  }
});
```

Babel æä¾›äº†[@babel/types](https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fnext%2Fbabel-types) ç”¨äºå®šä¹‰ AST èŠ‚ç‚¹ï¼Œåœ¨ visitor å¤„ç†èŠ‚ç‚¹çš„æ—¶å€™ç”¨äºæ–°å¢/æ›¿æ¢ç­‰æ“ä½œã€‚

è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬éå†ä¸Šä¸€æ­¥å¾—åˆ°çš„ ASTï¼Œåœ¨åŒ¹é…åˆ°å˜é‡å£°æ˜ `VariableDeclaration` æ—¶ï¼Œåˆ¤æ–­å€¼æ˜¯å¦ä¸º constï¼Œå¹¶æ“ä½œæ›¿æ¢æˆ varã€‚

### iii. ç”Ÿæˆï¼ˆgenerateï¼‰ä»£ç 

Babel æä¾›äº† [@babel/generator](https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fnext%2Fbabel-generator) æŠŠè½¬æ¢åçš„æœ€ç»ˆ AST è¿˜åŸä¸ºå­—ç¬¦ä¸²å½¢å¼çš„ä»£ç ï¼ŒåŒæ—¶åˆ›å»ºæºç æ˜ å°„ã€‚

```JS
const generate = require('@babel/generator').default;

let code = generate(ast).code;
```

ä»¥ä¸Šå°±æ˜¯ Babel åœ¨ç¼–è¯‘æ—¶çš„æµç¨‹ï¼Œè¿™é‡Œæ¶‰åŠåˆ°äº†å‡ ä¸ªå…³é”®çš„åŒ…ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9fa0ccad64054141bb70d24dca5cafa5~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1668&h=550&s=69741&e=jpg&b=fefefe)

- **@babel/types** ï¼šç”¨äºæ„å»ºã€éªŒè¯å’Œä¿®æ”¹ AST èŠ‚ç‚¹
- **@babel/parser**ï¼šæä¾›é»˜è®¤çš„ parse æ–¹æ³•ç”¨äºè§£æ
- **@babel/traverse**: å°è£…äº†å¯¹ AST æ ‘çš„éå†å’ŒèŠ‚ç‚¹çš„å¢åˆ æ”¹æŸ¥æ“ä½œ
- **@babel/generator**: æä¾›ç»™é»˜è®¤çš„ generate æ–¹æ³•ç”¨äºä»£ç ç”Ÿæˆ

æˆ‘ä»¬æ¥ä¸‹æ¥å†™çš„ç¼–è¯‘å™¨ï¼Œå°±æ˜¯åŸºäºä¸Šè¿°ä»‹ç»çš„ Babel åŒ…æ¥å®ç°ã€‚

# ä¸‰ã€Rax2Taro

é™¤äº†è½¬æ¢å·¥å…·ï¼Œæˆ‘ä»¬è¿˜éœ€è¦äº†è§£è¢«è½¬æ¢å’Œç”Ÿäº§çš„å¯¹è±¡ã€‚

å› æ­¤éœ€è¦äº†è§£ Rax å’Œ Taro æ¡†æ¶ï¼Œæ¯”è¾ƒä¸¤è€…çš„å·®å¼‚å’Œç›¸ä¼¼ä¹‹å¤„ï¼Œæ³¨æ„è½¬æ¢è¿‡ç¨‹ä¸­éœ€è¦æŠ¹å¹³çš„éƒ¨åˆ†ï¼š

- [**Rax**](https://rax.alibaba-inc.com/) æ˜¯é˜¿é‡Œå·´å·´çš„çš„è·¨ç«¯è§£å†³æ–¹æ¡ˆï¼Œå®ƒçš„è®¾è®¡ç†å¿µä¸ React ç±»ä¼¼ï¼Œæä¾›äº†ç±»ä¼¼çš„ç»„ä»¶åŒ–å¼€å‘ä½“éªŒï¼Œèƒ½å¤Ÿè¿è¡Œåœ¨ Webã€Node.jsã€é˜¿é‡Œå°ç¨‹åºã€Weex ç­‰å¤šä¸ªå¹³å°ã€‚

- [**Taro**](https://docs.taro.zone/docs/) æ˜¯äº¬ä¸œçš„è·¨ç«¯è·¨æ¡†æ¶è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒä½¿ç”¨ React è¯­æ³•å¼€å‘ä¸€æ¬¡ï¼Œç„¶åå°†ä»£ç ç¼–è¯‘æˆä¸åŒå¹³å°çš„å°ç¨‹åºï¼ˆå¾®ä¿¡/ç™¾åº¦/æ”¯ä»˜å®/å­—èŠ‚è·³åŠ¨/äº¬ä¸œå°ç¨‹åºç­‰ï¼‰å’Œ H5 åº”ç”¨ï¼Œç”šè‡³å¯ä»¥ç¼–è¯‘æˆ React Native åº”ç”¨ã€‚

é€šè¿‡é˜…è¯»å¯¹æ¯”äºŒè€…å®˜æ–¹æ–‡æ¡£ï¼Œå¯»æ‰¾åˆ°æ¥ä¸‹æ¥å¼€å‘çš„å…³é”®ç ´å±€ç‚¹ï¼š**Rax å’Œ Taro å‡æ”¯æŒç»„ä»¶åŒ–å¼€å‘**

ç”±äº Rax å’Œ Taro éƒ½å—åˆ° React çš„å½±å“ï¼Œå¹¶ä¸”éƒ½ä½¿ç”¨ JSX è¯­æ³•ï¼Œå¯¼è‡´å®ƒä»¬çš„è®¸å¤šåŸºç¡€ç»„ä»¶åœ¨æ¦‚å¿µä¸Šæ˜¯ç±»ä¼¼çš„ï¼Œè¿™æ„å‘³ç€æœ‰ä¸€äº›ç»„ä»¶å’Œå±æ€§æ˜¯å¯ä»¥åœ¨ä¸¤è€…ä¹‹é—´ç›´æ¥æ˜ å°„çš„ã€‚

## 01 | æœ¬æœŸç›®æ ‡

ä»ç»„ä»¶åŒ–ä¸‹æ‰‹ï¼Œæœ¬æœŸç¼–è¯‘å™¨èƒ½åŠ›è®¡åˆ’å°†å·¦ä¾§ Rax æ–‡æ¡£ä¸­ï¼ˆé™¤ Link å¤–ï¼‰çš„ 7 ä¸ªç»„ä»¶ä¸€é”®è½¬æ¢ Taro ç»„ä»¶

- åœ¨ Taro ä¸­ä¼˜å…ˆå¯»æ‰¾å¹³æ›¿ç»„ä»¶ï¼Œè‹¥èƒ½æ‰¾åˆ°åˆ™å¢åŠ è½¬æ¢é€»è¾‘æŠ¹å¹³å·®å¼‚ï¼Œå®ç°è½¬æ¢å™¨ã€‚
- å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”ç»„ä»¶å°±æ ‡çº¢ï¼Œç­‰åç»­å¯¹ç‰¹ä¾‹åœ°ç»Ÿä¸€å¤„ç†ã€‚

![æˆªå±2024-03-05 14.43.27.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4cc51ae9e7cb44b29283af62719357d9~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=844&h=633&s=474851&e=png&b=fbfbfb)

## 02 | ç¼–è¯‘å™¨è®¾è®¡

![æˆªå±2024-03-05 14.42.37.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e97f2b5bd5e64774bd459ae4407973cf~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=808&h=685&s=366240&e=png&b=fefefe)

<p align=center>ç¼–è¯‘å™¨ç»“æ„è®¾è®¡</p>

```bash
/Rax2Taro
|-- /node_modules                 # é¡¹ç›®ä¾èµ–åº“å®‰è£…æ–‡ä»¶å¤¹
|-- /src
|   |-- index.js                  # ä¸»å…¥å£æ–‡ä»¶ï¼Œåè°ƒæ•´ä¸ªè½¬æ¢è¿‡ç¨‹
|   |-- parser.js                 # ç”¨äºè§£ææºä»£ç ç”Ÿæˆ AST
|   |-- generator.js              # ç”¨äºä»ä¿®æ”¹åçš„ AST ç”Ÿæˆæ–°çš„æºä»£ç 
|-- /Transformers                 # å­˜æ”¾è½¬æ¢é€»è¾‘çš„æ¨¡å—æ–‡ä»¶å¤¹
|   |-- index.js                  # æ•´åˆå„ç§è½¬æ¢è§„åˆ™çš„ä¸»è¦è½¬æ¢å™¨
|   |-- FunctionTransformer.js    # å‡½æ•°è½¬æ¢é€»è¾‘
|   |-- /JSXElementsTransformer   # å­˜æ”¾ JSX å…ƒç´ çš„ç‰¹å®šè½¬æ¢å™¨
|       |-- index.js              # æ•´åˆ JSX å…ƒç´ è½¬æ¢è§„åˆ™
|       |-- ...                   # å…¶ä»– JSX å…ƒç´ è½¬æ¢æ¨¡å—
|   |-- ...                       # å…¶ä»–è½¬æ¢é€»è¾‘æ¨¡å—
|-- /Input                        # å­˜æ”¾å¾…è½¬åŒ–çš„ Rax.js çš„æ–‡ä»¶å¤¹
|-- /Output                       # å­˜æ”¾è½¬åŒ–åçš„ Taro.js çš„æ–‡ä»¶å¤¹
|-- package.json                  # å®šä¹‰é¡¹ç›®ä¾èµ–å’Œè„šæœ¬
|-- README.md                     # é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

<p align=center>ç¼–è¯‘å™¨ä»£ç ç»“æ„è®¾è®¡</p>

## 03 | è½¬æ¢ View ç»„ä»¶

> ã€Œ å†™ä¸€ä¸ªç¼–è¯‘å™¨å¯èƒ½å¾ˆéš¾ï¼Œä½†æ˜¯è½¬æ¢ä¸€ä¸ªå°ç»„ä»¶å¾ˆç®€å• ã€

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è½¬æ¢ N ä¸ªåŸºæœ¬ç»„ä»¶ã€‚

ä¸€æ—¦æˆ‘ä»¬çŸ¥é“äº†å¦‚ä½•è½¬æ¢ View ç»„ä»¶ï¼Œæˆ‘ä»¬åªéœ€é‡å¤ç›¸åŒçš„æ­¥éª¤å…­æ¬¡å³å¯å®Œæˆç›®æ ‡ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†ä»¥ View ç»„ä»¶ä¸ºæ¡ˆä¾‹ï¼Œæ¢è®¨å¦‚ä½•åˆ¶å®šå•ä¸ªç»„ä»¶çš„è½¬æ¢è§„åˆ™ã€‚

**è½¬æ¢ï¼Œæœ¬è´¨å°±æ˜¯æ‰¾ä¸åŒï¼Œå¹¶è®©ä¸åŒå˜ç›¸åŒ**

![æˆªå±2024-03-05 14.44.43.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b8219dd7089b46aca2accdf612eb3af4~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2342&h=788&s=1001659&e=png&b=242330)

é€šè¿‡å¯¹æ¯”äºŒè€…ä»£ç ä¹‹é—´çš„å·®å¼‚ï¼Œæˆ‘ä»¬å‘ç°éœ€è¦åšè¿™ä¸‰ä»¶äº‹ï¼š

1.  Rax éœ€è¦å¼•å…¥ `createElement` ä¸ç„¶ä¼šæŠ¥é”™ï¼ŒTaro é™¤äº†ç»„ä»¶å¤–æ²¡å…¶ä»–å¼•å…¥è¡Œä¸ºï¼›
1.  Import å¼•å…¥å†™æ³•ä¸åŒï¼ŒRax ç”¨å•æ–‡ä»¶å¼•å…¥å•ç»„ä»¶ï¼ŒTaro æ˜¯åœ¨ `@tarojs/components` é›†ä¸­å¼•å…¥ï¼›
1.  åŒæ ·éƒ½æ˜¯`<View />`ç»„ä»¶ï¼Œä¸¤ä¸ªæ¡†æ¶é—´çš„ç»„ä»¶ API å±æ€§å¯èƒ½ä¸åŒï¼Œæˆ–è€…å±æ€§åç›¸åŒåŠŸèƒ½ä¸åŒã€‚éœ€è¦æŠ¹å¹³å·®å¼‚ï¼Œæˆ–è€…ç‰¹å¼‚å¤„ç†ï¼›

æ¥ä¸‹æ¥è®©æˆ‘ä»¬ä¸€æ­¥æ­¥å®ç°ï¼Œè‡³äºè¯»å–æ–‡ä»¶å’Œè½¬æ¢ SourceCode å¾—åˆ° AST éƒ¨åˆ†ä¸è®²ï¼Œå…·ä½“ç»†èŠ‚å¯ä»¥åœ¨ Github é‡Œçœ‹ï¼Œå°±ä¸¤è¡Œä»£ç ã€‚**ä¸‹è¿°ä¸€åˆ‡æ“ä½œå‡é»˜è®¤ä¸ºè½¬æ¢å™¨è·å–åˆ° AST ä¹‹å**ã€‚

### i. åˆ é™¤ createElement

```JS
// ä¸»å…¥å£æ–‡ä»¶
const traverse = require("@babel/traverse").default;
const importsTransformer = require("./ImportsTransformer");

function transform(ast) {
  traverse(ast, {
    ImportDeclaration(path) {
      importsTransformer.transformImportDeclaration(path);
    },
    // ... æ·»åŠ å…¶ä»–èŠ‚ç‚¹ç±»å‹çš„è½¬æ¢è§„åˆ™
  });
}

module.exports = {
  transform,
};
```

å¼€å§‹ä¹‹å‰ï¼Œé¦–å…ˆäº†è§£ä¸€ä¸‹è½¬æ¢å™¨ä¸»å…¥å£ç»“æ„ã€‚

ä¸»å…¥å£æ–‡ä»¶å¼•å…¥äº†`@babel/traverse`ï¼Œè¿˜å¼•å…¥æˆ‘ä»¬æ–°å¢ç”¨æ¥åˆ é™¤ createElement çš„æ–¹æ³•ã€‚

å…¶ä¸­ä½¿ç”¨äº†`traverse()`å‡½æ•°ï¼Œå®ƒç”¨äºéå†æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ï¼Œè®¿é—®æ ‘ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œå¹¶å¯¹è¿™äº›èŠ‚ç‚¹è¿›è¡Œä¿®æ”¹ã€æ·»åŠ æˆ–åˆ é™¤ã€‚

```JS
// åŠŸèƒ½å‡½æ•°
function transformImportDeclaration(path) {
  const importSource = path.node.source.value;

  // åˆ é™¤ "rax" æ¨¡å—é‡Œçš„ createElement
  if (importSource === "rax") {
    // è¿‡æ»¤ createElement å¼•å…¥
    path.node.specifiers = path.node.specifiers.filter(
      (specifier) =>
        !(
          t.isImportSpecifier(specifier) &&
          specifier.imported.name === "createElement"
        )
    );

    // åˆ é™¤ç©ºå¼•ç”¨
    if (path.node.specifiers.length === 0) {
      path.remove();
    }
  }
}
```

æ¥ä¸‹æ¥çœ‹åŠŸèƒ½å‡½æ•°ï¼Œå› ä¸ºä¼šéå†èŠ‚ç‚¹ï¼Œæ‰€ä»¥

1.  æˆ‘ä»¬é¦–å…ˆé€šè¿‡ `path.node.source.value=== "rax"` å®šä½ï¼Œæ‰¾åˆ°æˆ‘ä»¬è¦å¢åˆ æ”¹çš„ç›®æ ‡èŠ‚ç‚¹ï¼›
1.  ç„¶åè¿‡æ»¤è¿™ä¸ªè¯­å¥ä¸­çš„æ‰€æœ‰å¯¼å…¥è¯´æ˜ç¬¦ specifiers ï¼Œæ£€æŸ¥å€¼æ˜¯å¦ä¸º createElement

    - `path.node.specifiers` æ˜¯ AST ä¸­çš„ä¸€ä¸ªéƒ¨åˆ†ï¼Œè¡¨ç¤ºä¸€ä¸ªæ¨¡å—å¯¼å…¥è¯­å¥ä¸­çš„æ‰€æœ‰å¯¼å…¥è¯´æ˜ç¬¦ã€‚
    - `t.isImportSpecifier` æ˜¯ Babel ç±»å‹æ£€æŸ¥å™¨çš„ä¸€éƒ¨åˆ†ã€‚

1.  å¦‚æœæ˜¯ï¼Œå°±è¢«è¿‡æ»¤æ‰ã€‚
1.  æœ€ååŠ ä¸€æ­¥ç©ºå¼•ç”¨æ¸…é™¤ï¼Œåˆ é™¤ `import { } from 'rax'`

### ii. æ”¹å˜ç»„ä»¶å¼•å…¥å†™æ³•

å¼•å…¥å†™æ³•çš„ä¿®æ”¹æ–¹å¼ï¼Œç±»ä¼¼ä¸Šé¢çš„å¤„ç†æ–¹æ³•ï¼š

1.  å…ˆå®šä½æ‰¾åˆ° `import View from "rax-view"`ï¼Œåˆ é™¤è¿™å¥å¼•å…¥ï¼›
1.  å£°æ˜ä¸€ä¸ªå¯¹è±¡ï¼Œå­˜ Taro å¼•å…¥ç»„ä»¶ï¼ŒæŠŠä¸Šé¢åˆ æ‰çš„ç»„ä»¶å†ä»¥ `import { View } from "@tarojs/components"`çš„å½¢å¼å£°æ˜ï¼›

ä½†æ˜¯è€ƒè™‘åˆ°å¯æ‰©å±•æ€§ï¼Œä¹‹åè¿˜ä¼šé‡åˆ° Textã€Image ç­‰ç»„ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘å†™äº†ä¸€å¼ æ˜ å°„è¡¨ï¼Œæ‰¹é‡é‡å¤ä¸Šé¢æ“ä½œã€‚

```JS
const componentImportMap = {
  "rax-view": {
    source: "@tarojs/components",
    importName: "View",
  },
  "rax-text": {
    source: "@tarojs/components",
    importName: "Text",
  }
  // ... æ·»åŠ æ›´å¤šç»„ä»¶åŠå…¶è½¬æ¢è§„åˆ™
};

const taroComponentsToImport = new Set(); // å£°æ˜å»é‡ Taro å¯¹è±¡

  // åŸºç¡€ç»„ä»¶æ˜ å°„è½¬æ¢
function transformImportDeclaration(path) {
  const importSource = path.node.source.value;
  // ... createElement åˆ é™¤é€»è¾‘

  const newImportInfo = componentImportMap[importSource];
  if (newImportInfo) {
    // å¦‚æœæ˜ å°„è¡¨é‡Œæœ‰ï¼Œå°±å­˜è¿™ä¸ªå€¼åˆ° Taro å¯¹è±¡ä¸­
    taroComponentsToImport.add(newImportInfo.importName);
    path.remove(); // å¹¶ç§»é™¤åŸ rax-xxx å¯¼å…¥å£°æ˜
  }
}
```

ç”±äºåŠŸèƒ½ç±»ä¼¼ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªåŠŸèƒ½ï¼ˆåˆ é™¤ createElementã€æ”¹å˜ç»„ä»¶å¼•å…¥å†™æ³•ï¼‰æˆ‘éƒ½å†™åœ¨ `transformImportDeclaration` å‡½æ•°é‡Œã€‚

### iii. è½¬æ¢ View ç»„ä»¶

è½¬æ¢ View ç»„ä»¶å¬ä¸Šå»å¾ˆå¤æ‚ï¼Œå…¶å®æ‹†è§£ä¸‹ï¼Œæœ¬è´¨å°±æ˜¯æŠŠä¸¤å¥—å±æ€§å·®å¼‚æŠ¹å¹³ï¼Œç”¨çš„ä¹Ÿæ˜¯ä¸Šé¢å¯¹ AST èŠ‚ç‚¹çš„å¢åˆ æ”¹æ“ä½œã€‚

![æˆªå±2024-03-05 14.55.47.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/855d2d9e653b4b80ab52de371bdeecc4~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1736&h=782&s=970852&e=png&b=fcfcfc)

ä»äºŒè€…å®˜æ–¹æ–‡æ¡£é‡Œå±•ç¤ºçš„ç»„ä»¶ API å¯ä»¥æ˜æ˜¾çœ‹åˆ° Rax æ¯” Taro çš„ View å°‘äº†å¾ˆå¤šå±æ€§ï¼Œä½†ç”±äºæˆ‘ä»¬å®ç°çš„æ˜¯ **Rax -> Taro** çš„å•å‘è½¬æ¢ã€‚

æ‰€ä»¥**ä¸€åˆ‡ç¼–è¯‘è¡Œä¸ºä»¥ Rax API ä¸ºè½¬æ¢åŸºå‡†**ã€‚

è‡³äº Taro å¤šå‡ºæ¥çš„ API ï¼Œç¼–è¯‘å™¨ä¸ç”¨ç®¡ï¼Œå¦‚æœåç»­å¼€å‘éœ€è¦ç”¨åˆ° Taro å±æ€§ï¼Œåˆ™å¼€å‘è€…æ ¹æ® Taro å®˜æ–¹æ–‡æ¡£è‡ªè¡Œé…ç½®ä½¿ç”¨å³å¯(åæ­£ Rax æ²¡æœ‰ ğŸ’)

å¯¹æ¯” View API å·®å¼‚ï¼Œæˆ‘æ•´ç†å‡ºä¸‹é¢çš„è¡¨æ ¼å†…å®¹ï¼š

![æˆªå±2024-03-05 14.51.22.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7cd519bc9eec4e23bac7f19a7b01cd6f~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=842&h=872&s=561488&e=png&b=fcf0ec)
å¯ä»¥çœ‹åˆ°æœ‰ 5 æ¡ API å±æ€§æœ‰ä¸åŒï¼Œå…¶ä¸­ 3 æ¡æ˜¯ä½¿ç”¨æ–¹æ³•ä¸åŒï¼Œ2 æ¡æ˜¯éœ€è¦ç¼–è¯‘å™¨å¤„ç†çš„å±æ€§ã€‚

1. onClick -> onTap
2. onLongpress -> onLongTap

View è½¬æ¢å™¨çš„é€»è¾‘å¦‚ä¸‹ï¼š

```JS
const t = require("@babel/types");

function transformViewElement(path) {
  // ç¡®ä¿æˆ‘ä»¬åªå¤„ç†å…·æœ‰ name å±æ€§çš„ JSXElement
  if (path.node.openingElement && path.node.openingElement.name) {
    const openingElementName = path.node.openingElement.name;

    if (
      t.isJSXIdentifier(openingElementName) &&
      openingElementName.name === "View"
    ) {
      path.node.openingElement.attributes.forEach((attribute) => {
        if (t.isJSXAttribute(attribute) && attribute.name) {
          const attributeName = attribute.name.name;

          switch (attributeName) {
            case "onClick":
              attribute.name.name = "onTap";
              break;
            case "onLongpress":
              attribute.name.name = "onLongTap";
              break;
          }
        }
      });
    }
  }
}

module.exports = {
  transformViewElement,
};
```

è·Ÿä¹‹å‰æ“ä½œå·®ä¸å¤šï¼Œè¿˜æ˜¯éå†æ‰¾èŠ‚ç‚¹ï¼Œæ‰¾åˆ°è¦å¤„ç†çš„ API å±æ€§ï¼Œå°†å±æ€§é‡å‘½åã€‚

è‡³æ­¤ï¼Œæˆ‘ä»¬å®ç°äº† Rax -> Taro View ç»„ä»¶çš„ç¼–è¯‘è½¬æ¢ã€‚æ¥ä¸‹æ¥éœ€è¦å¯¹å‰©ä¸‹çš„ 6 ä¸ªåŸºç¡€ç»„ä»¶åšåŒæ ·æ“ä½œï¼Œå³å¯å®Œæˆæœ¬æœŸç›®æ ‡ï¼š

é‡å¤æµç¨‹å¦‚ä¸‹ï¼š

1.  åˆ—è¡¨æ ¼ï¼Œæ•´ç† API å·®å¼‚ï¼Œæ ‡æ˜å¤„ç†æ–¹å¼
1.  éå† AST æ‰¾å¯¹åº”èŠ‚ç‚¹ã€æ‰¾åˆ°éœ€è¦å¤„ç†çš„ API å±æ€§
1.  æ‰§è¡Œé‡å‘½å or åˆ é™¤åŠ¨ä½œ

æœºæ¢°æ€§åŠ¨ä½œ \* n ...

ä¸ºäº†ä¿è¯è½¬æ¢å™¨çš„æ‹“å±•æ€§ï¼Œè¿™é‡Œæ–°å¢äº†ä¸€ä¸ªä¸»å…¥å£ `index.js` æ–‡ä»¶ç”¨æ¥æ‰¹é‡ç®¡ç†å„ä¸ªç‹¬ç«‹ç»„å»ºçš„å°è½¬æ¢å™¨ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/80ba6bc8ce49453a9719c72dbf20aa1e~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2064&h=936&s=1072219&e=png&b=242330)

å…¶ä»–ç»„ä»¶çš„å¯¹åº”è¡¨è¯·åœ¨è¯­é›€æ–‡æ¡£æŸ¥çœ‹ï¼š

https://www.yuque.com/cascading/bwnowo/uwp3s510g0im9ue9?singleDoc# ã€ŠåŸºç¡€ç»„ä»¶ API å·®å¼‚ã€‹

# å››ã€è‡ªåŠ¨åŒ–æµ‹è¯•

ç”±äºåœ¨æœ¬åœ°è½¬æ¢å„ä¸ª API éœ€è¦åå¤è°ƒè¯•ï¼Œå¹¶ä¸”éœ€è¦å®æ—¶æŸ¥çœ‹ç»„ä»¶ç¼–è¯‘åçš„æƒ…å†µã€‚ä¸ºäº†å¼€å‘ææ•ˆï¼Œæˆ‘æœ¬åœ°è¿˜éœ€è¦è¿è¡Œ Rax å’Œ Taro ä¸¤ä¸ªç”¨è„šæ‰‹æ¶ç”Ÿæˆçš„é¡¹ç›®ï¼ŒåŠ ä¸€ä¸ªå°è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬è¿›è¡Œä¸€é”®ç¼–è¯‘è°ƒè¯•ã€‚

å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼Œåœ¨`e2e.test.js` ä¸­ï¼š

- è®¾å®š Rax é¡¹ç›®è·¯å¾„ï¼šæœ¬é¡¹ç›®ä» Rax åº”ç”¨çš„æºæ–‡ä»¶å¤¹`rax-test-demo/src/index.js`è¯»å–å¾…è½¬æ¢ç»„ä»¶ä»£ç ã€‚
- è®¾å®š Taro é¡¹ç›®è·¯å¾„ï¼šå°†è½¬æ¢åçš„ Taro ç»„ä»¶ä»£ç å†™å…¥ Taro åº”ç”¨çš„ç›®æ ‡æ–‡ä»¶å¤¹ `TaroTestDemo/src/app.js`
- è½¬æ¢ä»£ç ï¼šå‘½ä»¤è¡Œæ‰§è¡Œï¼š`npm run test:e2e` è½¬æ¢å™¨å°†æºä»£ç è§£æä¸º ASTï¼Œå¹¶è¿›è¡Œè½¬æ¢ã€‚
- ç›‘æµ‹è½¬æ¢ç»“æœï¼šåœ¨ Taro æµ‹è¯•ç¯å¢ƒä¸­æ£€æŸ¥è½¬æ¢åçš„ä»£ç ï¼Œç¡®ä¿æ²¡æœ‰æŠ¥é”™ä¸”ç¬¦åˆé¢„æœŸã€‚

```JS
const fs = require("fs");
const path = require("path");
const { transform } = require("../src/Transformers");
const parser = require("@babel/parser");
const generator = require("@babel/generator").default;

// åŸºäºä½  Rax æºæ–‡ä»¶å’Œ Taro è¾“å‡ºçš„è·¯å¾„
const raxSourcePath = path.join(__dirname, "../../rax-test-demo/src/index.js");
const taroOutputPath = path.join(
  __dirname,
  "../../TaroTestDemo/src/pages/index/index.jsx"
);

describe("End-to-End Transformation", () => {
  it("ä»Raxç»„ä»¶ä¸­è¯»å–æºç ï¼Œè½¬æ¢ä¸ºTaroç»„ä»¶", () => {
    const raxSourceCode = fs.readFileSync(raxSourcePath, "utf8");

    // 1.è§£æ Rax æºä»£ç ä¸º AST
    const raxAst = parser.parse(raxSourceCode, {
      sourceType: "module",
      plugins: ["jsx"],
    });
    // 2.è½¬æ¢ AST
    transform(raxAst);
    // 3.ç”Ÿæˆè½¬æ¢åçš„ Taro æºä»£ç 
    const taroOutput = generator(raxAst, {});

    fs.writeFileSync(taroOutputPath, taroOutput.code);
  });
});
```

## 01 | å‡†å¤‡ Rax æµ‹è¯•ç¯å¢ƒ

```bash
npm install -g rax-cli # å®‰è£… Rax è„šæ‰‹æ¶ï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰

cd Desktop # è¿›å…¥æ¡Œé¢
rax init RaxTestDemo # åˆå§‹åŒ– Rax é¡¹ç›®

cd rax-test-demo # è¿›å…¥æ–‡ä»¶å¤¹
npm install # å®‰è£…ä¾èµ–
npm start # è¿è¡Œ
```

è„šæ‰‹æ¶é€‰é¡¹å¦‚ä¸‹ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3e5dfbebdfbe4e4da25f3ed84f5480bd~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1626&h=294&s=317538&e=png&b=050505)

## 02 | å‡†å¤‡ Taro æµ‹è¯•ç¯å¢ƒ

```bash
npm install -g @tarojs/cli # å®‰è£… Taro è„šæ‰‹æ¶ï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰

cd Desktop # è¿›å…¥æ¡Œé¢
taro init TaroTestDemo # åˆå§‹åŒ– Taro é¡¹ç›®

cd TaroTestDemo # è¿›å…¥æ–‡ä»¶å¤¹
npm install # å®‰è£…ä¾èµ–
npm run dev:h5 # è¿è¡Œ
```

è„šæ‰‹æ¶é€‰é¡¹å¦‚ä¸‹ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d1ca0d47020a44f3a63a6d18c1ae6a5e~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1588&h=684&s=591533&e=png&b=040404)

ç¡®ä¿éµå¾ªä¸Šè¿°æ­¥éª¤æ¥å‡†å¤‡ Rax å’Œ Taro çš„æµ‹è¯•ç¯å¢ƒã€‚åœ¨åŒæ–¹éƒ½æ„å»ºå®Œæˆåï¼Œæ‚¨å¯ä»¥æ‰§è¡Œ Jest æµ‹è¯•æ¥éªŒè¯è½¬æ¢è¿‡ç¨‹ã€‚

## 03 | æ‰§è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e2492fa519cd436db8e196def116c42a~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=972&h=556&s=276700&e=png&b=252432)

1.  å®‰è£… [Jest](https://jestjs.io/) å‘½ä»¤è¡Œæ‰§è¡Œï¼š`npm install --save-dev jest`
1.  package.json é…ç½®ï¼š`"test:e2e": "jest tests/e2e.test.js"`
1.  å‘½ä»¤è¡Œæ‰§è¡Œï¼š`npm run test:e2e`

æ­¤æ—¶ï¼Œä½ å°±å¯ä»¥åœ¨æœ¬åœ°åŒæ—¶è¿è¡Œ Rax ä¸ Taro é¡¹ç›®ï¼Œä¸€è¾¹å†™ Rax ä¸€è¾¹å¯å®æ—¶é€šè¿‡æ­¤æ¡å‘½ä»¤è¿›è¡Œç¼–è¯‘è½¬æ¢ Taroã€‚

# äº”ã€æ€»ç»“

æœ¬ç¯‡æ–‡ç« ä»é›¶å¼€å§‹æ„é€ äº†ä¸€ä¸ªç•¥å…·å¤æ‚åº¦çš„ Rax è½¬ Taro ç¼–è¯‘å™¨ã€‚

åˆå§‹ç›®æ ‡æŒºå“äººï¼Œä½†ç»è¿‡åˆç†æ‹†è§£å‘ç°å¤§ç›®æ ‡ä¹Ÿä¸è¿‡åªæ˜¯èµ°é€š MVPï¼ˆæœ€å°å¯è¡Œäº§å“ï¼‰åçš„é‡å¤ç´¯åŠ ã€‚å·¥ä½œå¦‚æ­¤ï¼Œç”Ÿæ´»äº¦å¦‚æ­¤ã€‚ä¸“æ³¨ä½ çš„ç›®æ ‡ï¼Œä¸è¦è¢«çº·ç¹çš„ä¿¡æ¯æµå½±å“ï¼Œè„šè¸å®åœ°ä¸€æ­¥æ­¥å®Œæˆä½ çš„å° Stepï¼Œä¸€åˆ‡æ€»èƒ½å®Œæˆçš„ã€‚

åç»­å¯¹è¿™ä¸ªç¼–è¯‘å™¨ï¼Œæˆ‘è®¡åˆ’å¦‚ä¸‹å†…å®¹ï¼Œæ¬¢è¿æŒç»­å…³æ³¨ï¼š

- æ–°å¢è‡ªå®šä¹‰è„šæ‰‹æ¶åŠŸèƒ½
- æŠ¹å¹³è½¬æ¢è¿‡ç¨‹ä¸­çš„ CSS æ ·å¼å·®å¼‚
- æ–°å¢ README_EN å®Œå–„ä¸­è‹±æ–‡ä½¿ç”¨æ–‡æ¡£

å†™ä½œä¸æ˜“ï¼Œå¦‚æœè§‰å¾—æœ¬æ–‡å¯¹ä½ æœ‰å¯å‘æœ‰å¸®åŠ©çš„è¯ï¼Œè¯·åœ¨ [GitHub](https://github.com/Trade-Offf/Rax2Taro?tab=readme-ov-file) å¸®æˆ‘ç‚¹ä¸ª Star â­

äº¤ä¸ªæœ‹å‹ï¼Œæ„¿æˆ‘ä»¬æ›´é«˜å¤„ç›¸è§ï¸ï¼Œæ¯”å¿ƒæ„Ÿè°¢ â¤ ~~~
