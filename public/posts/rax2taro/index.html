<!DOCTYPE html>
<html lang="en-us"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">Rax2Taro | Trade-Offf Blog</title>
<meta property="og:title" content="Rax2Taro | Trade-Offf Blog" />
<meta name="twitter:title" content="Rax2Taro | Trade-Offf Blog" />
<meta itemprop="name" content="Rax2Taro | Trade-Offf Blog" />
<meta name="application-name" content="Rax2Taro | Trade-Offf Blog" />
<meta property="og:site_name" content="" />

<meta name="description" content="">
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />

<meta property="og:locale" content="en-us" />
<meta name="language" content="en-us" />

  <link rel="alternate" hreflang="en" href="http://localhost:1313/posts/rax2taro/" title="" />



  <meta itemprop="image" content="http://localhost:1313/" />
  <meta property="og:image" content="http://localhost:1313/" />
  <meta name="twitter:image" content="http://localhost:1313/" />
  <meta name="twitter:image:src" content="http://localhost:1313/" />




    
    
    

    <meta property="og:type" content="article" />
    <meta property="og:article:published_time" content=2024-04-16T20:06:23&#43;0800 />
    <meta property="article:published_time" content=2024-04-16T20:06:23&#43;0800 />

    

    

    <script defer type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Article",
        "headline": "Rax2Taro",
        "author": {
        "@type": "Person",
        "name": ""
        },
        "datePublished": "2024-04-16",
        "description": "",
        "wordCount":  1030 ,
        "mainEntityOfPage": "True",
        "dateModified": "2024-04-16",
        "image": {
        "@type": "imageObject",
        "url": ""
        },
        "publisher": {
        "@type": "Organization",
        "name": "Trade-Offf Blog"
        }
    }
    </script>


<meta name="generator" content="Hugo 0.124.1">

    

    <link rel="canonical" href="http://localhost:1313/posts/rax2taro/">
    <link href="/style.min.d43bc6c79baa87f006efb2b92be952faeedeb1a3ab626c1d6abda52eae049355.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="http://localhost:1313/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    </head>
<body data-theme = "" class="notransition">

<script src="/js/theme.js"></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="http://localhost:1313/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title></title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/posts/">
                        Posts
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/about/">
                        About
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">Rax2Taro</h1>
                
                
                <div class="post-meta">
                    <time datetime="2024-04-16T20:06:23&#43;08:00" itemprop="datePublished"> Apr 16, 2024 </time>
                </div>
                
            </header>
            
            <div class="page-content">
                <p><img src="https://cdn.nlark.com/yuque/0/2024/png/2019260/1709802874340-5bc3475e-a5db-4eb3-9897-a22f7c4119c5.png#averageHue=%23161a1f&amp;clientId=uaa3214db-c1ef-4&amp;from=ui&amp;id=udcce31af&amp;originHeight=956&amp;originWidth=1716&amp;originalType=binary&amp;ratio=2&amp;rotation=0&amp;showTitle=false&amp;size=761538&amp;status=done&amp;style=shadow&amp;taskId=ue48ac1bd-b909-47f4-9d53-d7c3f224838&amp;title=" alt="截屏2024-03-07 17.14.17.png">
<strong>「Rax2Taro」</strong>：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTrade-Offf%2FRax2Taro%3Ftab%3Dreadme-ov-file">点击查看 Github 地址</a></p>
<h1 id="一前置背景">一、前置背景</h1>
<p>笔者日常使用 Rax 框架开发前端需求。但随着业务扩展，我面临一个头痛的需求：将现有的 Rax 组件适配为 Taro 组件，以实现一些特定商业场景的跨平台功能。
这一需求可以概括为：</p>
<ul>
<li><strong>新功能开发</strong> - 在 Taro 框架中实现，确保多端兼容性。</li>
<li><strong>旧功能复用</strong> - 将现有 Rax 组件转换为 Taro，避免重写。</li>
</ul>
<p>重写组件成本高昂，特别是对于缺乏文档和原开发者不在的旧组件。因此我们需要一种自动化工具，能够轻松地**「一键式」**将 Rax 组件转化为 Taro 组件，减少工作量，加快开发进程。
本篇博客将探讨构建一个 Rax 到 Taro 的编译器，从零开始实现组件级转换。</p>
<blockquote>
<p>恐惧通常来自未知，你恐惧的不是写一个编译器，你恐惧的是你从来没有写过编译器。</p>
</blockquote>
<p>作为前端同学，如果接到这种工作可能会汗流浃背。
但不要担心，只要我们把目标拆解到足够清晰、足够细化，一切困难都是纸老虎。</p>
<h1 id="二编译器">二、编译器</h1>
<p>编译器是个宽泛的概念，最初是指将<strong>高级语言</strong>转换为计算机能识别的<strong>汇编/机器语言</strong>的工具。
<strong>个人理解：<strong>编译器本质是个从 A 转换的 B 的翻译工具（如有不妥，请评论区指出 🤝</strong>）</strong>
<img src="https://cdn.nlark.com/yuque/0/2024/jpeg/2019260/1709279932570-0790c102-b5b1-4db3-bc63-c2034d712f70.jpeg" alt="">
<strong>以本文目标为例，编译器的作用如上图</strong>
但是编译器的翻译过程不是简单的翻译，通常涉及到多个步骤（词法、语法、语义分析、中间代码生成等）。详细知识点不赘述了，感兴趣的朋友请翻阅<a href="https://book.douban.com/subject/3296317/">《编译原理》</a>。</p>
<h2 id="01--babeljavascript-编译器">01 | Babel：JavaScript 编译器</h2>
<p>我们以日常开发中，接触最多的 JavaScript 编译器 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fbabeljs.io%2F">Babel</a> 为例，了解编译器工作逻辑，这里只介绍 Babel 基本流程。更多详细内容可以看以下 Github 官方文档：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fjamiebuilds%2Fbabel-handbook%2Fblob%2Fmaster%2Ftranslations%2Fzh-Hans%2Fplugin-handbook.md">Babel 插件手册</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/jpeg/2019260/1709284639359-b739b068-4cd4-4383-a8a0-71ac674bf84c.jpeg" alt="">
<strong>Babel 工作流程</strong></p>
<h2 id="02--基本用法">02 | 基本用法</h2>
<p>这里以<code>const a = 1</code>转换成<code>var a = 1</code>为例，看下 Babel 是如何工作的：</p>
<h3 id="i-解析parse成抽象语法树-ast">i. 解析（parse）成抽象语法树 AST</h3>
<blockquote>
<p>抽象语法树（Abstract Syntax Tree，AST），是源代码语法结构的一种抽象表示。它以树状的形式表现编程语言的语法结构，树上的每个节点都表示源代码中的一种结构。</p>
</blockquote>
<p>**Babel 提供了 <strong><a href="https://babeljs.io/docs/babel-parser"><strong>@babel/parser</strong></a></strong> 将代码解析成 AST。**这一步主要做两件事：</p>
<ul>
<li>词法分析：把代码转换为令牌流（tokens flow：解析的中间产物，不用管）</li>
<li>语法分析：再把每个 token 转换为 AST 结构</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">parse</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;@babel/parser&#34;</span><span class="p">).</span><span class="nx">parse</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="s2">&#34;const a = 1&#34;</span><span class="p">);</span>
</span></span></code></pre></div><h3 id="ii-转换transformast">ii. 转换（transform）AST</h3>
<p><strong>Babel 提供了 <strong><a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fnext%2Fbabel-traverse"><strong>@babel/traverse</strong></a></strong> 对解析后的 AST 进行处理。</strong>
转换接收 AST 并对其遍历，在此过程中对节点进行增删改查，是 Babel 编译器最核心的过程。
<code>traverse()</code>能够接收 ast 以及 visitor 两个参数：</p>
<ul>
<li><strong>ast</strong> 是上一步解析得到的抽象语法树。</li>
<li><strong>visitor</strong> 提供访问不同节点的能力，当遍历到一个匹配的节点时，能够调用具体方法对节点进行处理。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">traverse</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;@babel/traverse&#34;</span><span class="p">).</span><span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;@babel/types&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">traverse</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">VariableDeclaration</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">kind</span> <span class="o">===</span> <span class="s2">&#34;const&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">path</span><span class="p">.</span><span class="nx">replaceWith</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">t</span><span class="p">.</span><span class="nx">variableDeclaration</span><span class="p">(</span><span class="s2">&#34;var&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">declarations</span><span class="p">)</span> <span class="c1">//替换成var
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">path</span><span class="p">.</span><span class="nx">skip</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><p><strong>Babel 提供了</strong><a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fnext%2Fbabel-types"><strong>@babel/types</strong></a>** 用于定义 AST 节点，在 visitor 里做节点处理的时候用于替换等操作。**
在这个例子中，我们遍历上一步得到的 AST，在匹配到变量声明<code>VariableDeclaration</code>时，判断值是否为 const 操作时进行替换成 var。</p>
<h3 id="iii-生成generate代码">iii. 生成（generate）代码</h3>
<p><strong>Babel 提供了 <strong><a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fnext%2Fbabel-generator"><strong>@babel/generator</strong></a></strong> 将 AST 再还原成代码。</strong>
把转换后的最终 AST 还原为字符串形式的代码，同时创建源码映射（source maps）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">generate</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;@babel/generator&#34;</span><span class="p">).</span><span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">generate</span><span class="p">(</span><span class="nx">ast</span><span class="p">).</span><span class="nx">code</span><span class="p">;</span>
</span></span></code></pre></div><p>以上就是 Babel 在编译时的流程，这里涉及到了几个关键的包，总结如下图：
<img src="https://cdn.nlark.com/yuque/0/2024/jpeg/2019260/1710298160849-026739af-02ff-4709-b12d-597d3d84d0bd.jpeg" alt="">
我们接下来写的编译器，就是基于上述介绍的 Babel 包来实现。</p>
<h1 id="三rax2taro">三、Rax2Taro</h1>
<p>除了转换工具，我们还需要了解被转换和生产的对象。
因此需要了解 Rax 和 Taro 框架，比较两者的差异和相似之处，注意转换过程中需要抹平的部分：
<a href="https://rax.alibaba-inc.com/">「Rax」</a> 是阿里巴巴的的跨端解决方案，它的设计理念与 React 类似，提供了类似的组件化开发体验，能够运行在 Web、Node.js、阿里小程序、Weex 等多个平台。
<a href="https://docs.taro.zone/docs/">「Taro」</a> 是京东的跨端跨框架解决方案，支持使用 React 语法开发一次，然后将代码编译成不同平台的小程序（微信/百度/支付宝/字节跳动/京东小程序等）和 H5 应用，甚至可以编译成 React Native 应用。</p>
<p>通过阅读对比二者官方文档，寻找到接下来开发的<strong>关键破局点：Rax 和 Taro 均支持组件化开发</strong>
由于 Rax 和 Taro 都受到 React 的影响，并且都使用 JSX 语法，它们的许多基础组件在概念上是类似的，这意味着有一些组件和属性是可以在两者之间直接映射的。</p>
<h2 id="01--本期目标">01 | 本期目标</h2>
<p>从组件化下手，本期编译器能力计划将左侧 Rax 文档中（除 Link 外）的 7 个组件一键转换 Taro 组件</p>
<ul>
<li>在 Taro 中优先寻找平替组件，若能找到则增加转换逻辑抹平差异，实现转换器。</li>
<li>如果找不到对应组件就标红，等后续对特例地统一处理。</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/2019260/1709286113155-c78a2296-e6dd-4543-9931-e649d9bdf20a.png#averageHue=%23fafafa&amp;clientId=ua589d88f-7b83-4&amp;from=ui&amp;id=u10a0935f&amp;originHeight=582&amp;originWidth=772&amp;originalType=binary&amp;ratio=2&amp;rotation=0&amp;showTitle=false&amp;size=333861&amp;status=done&amp;style=shadow&amp;taskId=ued5734eb-be72-481a-aeac-d8c4e42c5b9&amp;title=" alt="截屏2024-03-01 17.41.31.png"></p>
<h2 id="02--编译器结构设计">02 | 编译器结构设计</h2>
<p><img src="https://cdn.nlark.com/yuque/0/2024/jpeg/2019260/1709607531157-e185be69-8672-4245-b612-9926bcad5b23.jpeg" alt="">
<strong>编译器结构设计</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">/Rax2Taro
</span></span><span class="line"><span class="cl">|-- /node_modules # 项目依赖库安装文件夹
</span></span><span class="line"><span class="cl">|-- /src
</span></span><span class="line"><span class="cl">| |-- index.js # 主入口文件，协调整个转换过程
</span></span><span class="line"><span class="cl">| |-- parser.js # 用于解析源代码生成 AST
</span></span><span class="line"><span class="cl">| |-- generator.js # 用于从修改后的 AST 生成新的源代码
</span></span><span class="line"><span class="cl">|-- /Transformers # 存放转换逻辑的模块文件夹
</span></span><span class="line"><span class="cl">| |-- index.js # 整合各种转换规则的主要转换器
</span></span><span class="line"><span class="cl">| |-- FunctionTransformer.js # 函数转换逻辑
</span></span><span class="line"><span class="cl">| |-- /JSXElementsTransformer # 存放 JSX 元素的特定转换器
</span></span><span class="line"><span class="cl">| |-- index.js # 整合 JSX 元素转换规则
</span></span><span class="line"><span class="cl">| |-- ... # 其他 JSX 元素转换模块
</span></span><span class="line"><span class="cl">| |-- ... # 其他转换逻辑模块
</span></span><span class="line"><span class="cl">|-- /Input # 存放待转化的 Rax.js 的文件夹
</span></span><span class="line"><span class="cl">|-- /Output # 存放转化后的 Taro.js 的文件夹
</span></span><span class="line"><span class="cl">|-- package.json # 定义项目依赖和脚本
</span></span><span class="line"><span class="cl">|-- README.md # 项目说明文档
</span></span></code></pre></div><p><strong>编译器代码结构设计</strong></p>
<h2 id="03--转换-view-组件">03 | 转换 View 组件</h2>
<blockquote>
<p>「 写一个编译器可能很难，但是转换一个小组件很简单 」</p>
</blockquote>
<p>我们的目标是转换 N 个基本组件。
一旦我们知道了如何转换 View 组件，我们只需重复相同的步骤六次即可完成目标。因此，我们将以 View 组件为案例，探讨如何制定单个组件的转换规则。</p>
<p><strong>「转换，本质就是找不同，并让不同变相同」</strong>
<img src="https://cdn.nlark.com/yuque/0/2024/png/2019260/1709605733033-93c9c6f4-a997-4ce0-bcf2-c73081f9128c.png#averageHue=%23444654&amp;clientId=u9be0d808-8907-4&amp;from=ui&amp;id=VNbaZ&amp;originHeight=772&amp;originWidth=1338&amp;originalType=binary&amp;ratio=2&amp;rotation=0&amp;showTitle=false&amp;size=150216&amp;status=done&amp;style=shadow&amp;taskId=u3c121db2-7f09-4a08-9a0a-d623e6c1275&amp;title=" alt="image.png">
<strong>Rax</strong>
<img src="https://cdn.nlark.com/yuque/0/2024/png/2019260/1709605733180-db0900c7-5ecb-48e6-8a24-aa6d5fe05d8f.png#averageHue=%23454855&amp;clientId=u9be0d808-8907-4&amp;from=ui&amp;id=PBj7w&amp;originHeight=724&amp;originWidth=1322&amp;originalType=binary&amp;ratio=2&amp;rotation=0&amp;showTitle=false&amp;size=139284&amp;status=done&amp;style=shadow&amp;taskId=ub19fe133-0dfb-4270-b751-968870b7538&amp;title=" alt="image.png">
<strong>Taro</strong>
通过对比二者代码之间的差异，我们发现需要做这三件事：</p>
<ol>
<li>Rax 需要引入 <code>createElement</code> 不然会报错，Taro 除了组件外没其他引入行为；</li>
<li>Import 引入写法不同，Rax 用单文件引入单组件，Taro 是在 @tarojs/components 集中引入；</li>
<li>同样都是<View />组件，两个框架间的组件 API 属性可能不同，或者属性名相同功能不同。需要抹平差异，或者特异处理；</li>
</ol>
<p>接下来让我们一步步实现。读取文件和转换 SourceCode 得到 AST 部分不讲，具体细节可以在 Github 项目里看，就两行代码。<strong>下述一切操作均默认为转换器获取到 AST 之后</strong>。</p>
<h3 id="i-删除-createelement">i. 删除 createElement</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">traverse</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;@babel/traverse&#34;</span><span class="p">).</span><span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">importsTransformer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;./ImportsTransformer&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">transform</span><span class="p">(</span><span class="nx">ast</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">traverse</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ImportDeclaration</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">importsTransformer</span><span class="p">.</span><span class="nx">transformImportDeclaration</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ... 添加其他节点类型的转换规则
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">transform</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>开始之前，首先了解一下转换器主入口结构。
引入了<code>@babel/traverse</code>，引入我们之后用来删除 createElement 的方法。
其中使用了<code>traverse()</code>函数，它用于遍历抽象语法树（AST），允许访问树中的每个节点，并对这些节点进行修改、添加或删除。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">transformImportDeclaration</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">importSource</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 删除 &#34;rax&#34; 模块里的 createElement
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">importSource</span> <span class="o">===</span> <span class="s2">&#34;rax&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 过滤 createElement 引入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">path</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">specifiers</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">specifiers</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nx">specifier</span><span class="p">)</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">!</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nx">t</span><span class="p">.</span><span class="nx">isImportSpecifier</span><span class="p">(</span><span class="nx">specifier</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">          <span class="nx">specifier</span><span class="p">.</span><span class="nx">imported</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s2">&#34;createElement&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 删除空引用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">specifiers</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">path</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>接下来看功能函数，因为会遍历节点，所以</p>
<ol>
<li>我们首先通过<code>path.node.source.value=== &quot;rax&quot;</code>定位，找到我们要增删改的目标节点；</li>
<li>然后过滤这个语句中的所有导入说明符<code>specifiers</code> ，检查值是否为 createElement
<ul>
<li><code>path.node.specifiers</code> 是 AST 中的一个部分，表示一个模块导入语句中的所有导入说明符。</li>
<li><code>t.isImportSpecifier</code> 是 Babel 类型检查器的一部分。</li>
</ul>
</li>
<li>如果是，就被过滤掉。</li>
<li>最后加一步空引用清除，删除<code>import { } from 'rax'</code></li>
</ol>
<h3 id="ii-改变组件引入写法">ii. 改变组件引入写法</h3>
<p>引入写法修改类似上面处理方法：</p>
<ol>
<li>先定位找到 <code>import View from &quot;rax-view&quot;</code>，删掉这句引入</li>
<li>声明一个对象，存 Taro 引入组件，把上面删掉的组件再以 <code>import { View } from &quot;@tarojs/components&quot;</code>的形式声明</li>
</ol>
<p>但是考虑到可扩展性，之后还会遇到 Text、Image 等组件，所以这里我写了一张映射表，批量重复上面操作。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">componentImportMap</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;rax-view&#34;</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">source</span><span class="o">:</span> <span class="s2">&#34;@tarojs/components&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">importName</span><span class="o">:</span> <span class="s2">&#34;View&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;rax-text&#34;</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">source</span><span class="o">:</span> <span class="s2">&#34;@tarojs/components&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">importName</span><span class="o">:</span> <span class="s2">&#34;Text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ... 添加更多组件及其转换规则
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">taroComponentsToImport</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">();</span> <span class="c1">// 声明去重 Taro 对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 基础组件映射转换
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">transformImportDeclaration</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">importSource</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ... createElement 删除逻辑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">newImportInfo</span> <span class="o">=</span> <span class="nx">componentImportMap</span><span class="p">[</span><span class="nx">importSource</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">newImportInfo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果映射表里有，就存这个值到 Taro 对象中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">taroComponentsToImport</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">newImportInfo</span><span class="p">.</span><span class="nx">importName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">path</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span> <span class="c1">// 并移除原 rax-xxx 导入声明
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>由于功能类似，所以这两个功能我都写在 <code>transformImportDeclaration</code> 函数里了。</p>
<h3 id="iii-转换-view-组件">iii. 转换 View 组件</h3>
<p>转换 View 组件听着挺复杂，其实拆解下，本质就是把两套属性差异抹平，用的也是上面对 AST 节点的增删改操作。
<img src="https://cdn.nlark.com/yuque/0/2024/png/2019260/1709617208202-1c61e84f-d576-4ded-bf1b-726b8991fc0b.png#averageHue=%23fafafa&amp;clientId=u9be0d808-8907-4&amp;from=ui&amp;height=1048&amp;id=ub3fd1ad7&amp;originHeight=1054&amp;originWidth=1744&amp;originalType=binary&amp;ratio=2&amp;rotation=0&amp;showTitle=false&amp;size=812228&amp;status=done&amp;style=shadow&amp;taskId=u56f8cf83-31c4-4d11-a128-08f8260dd2a&amp;title=&amp;width=1734" alt="截屏2024-03-05 13.39.21.png">
<img src="https://cdn.nlark.com/yuque/0/2024/png/2019260/1709617214969-8aea45a7-9128-438b-b581-4a26771de03b.png#averageHue=%23fafafa&amp;clientId=u9be0d808-8907-4&amp;from=ui&amp;height=1818&amp;id=u378ab4af&amp;originHeight=1828&amp;originWidth=2168&amp;originalType=binary&amp;ratio=2&amp;rotation=0&amp;showTitle=false&amp;size=1887461&amp;status=done&amp;style=shadow&amp;taskId=ub954756d-606c-4219-bbb6-c33c6e78349&amp;title=&amp;width=2156" alt="截屏2024-03-05 13.39.37.png">
从二者官方文档里展示的组件 API 可以明显看到 Rax 比 Taro 的 View 少了很多属性，但由于我们实现的是 <strong>Rax -&gt; Taro <strong>的单向转换，所以</strong>「一切编译行为以 Rax API 为转换基准」</strong>。
至于 Taro 多出来的 API ，编译器不用管，如果后续开发需要用到 Taro 属性，则开发者根据 Taro 官方文档自行配置使用即可(反正 Rax 没有 🐒)</p>
<p>对比 View API 差异，我整理出下面的表格内容：</p>
<ul>
<li>红色背景：API 不同，需编译转换。</li>
<li>黄色背景：API 相同，无需编译转换。<strong>但功能有差异，使用过程中要注意</strong></li>
<li>灰色背景：无法兼容，编译过程中删除；</li>
<li>无背景：API 相同，无需编译转换。
<table>
<thead>
<tr>
<th><strong>Rax 属性</strong></th>
<th><strong>Rax 描述</strong></th>
<th><strong>Taro 属性</strong></th>
<th><strong>Taro 描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>className</td>
<td>自定义样式名</td>
<td>className</td>
<td>自定义样式名</td>
</tr>
<tr>
<td>style</td>
<td>自定义样式</td>
<td>style</td>
<td>自定义样式</td>
</tr>
<tr>
<td><strong>onClick</strong></td>
<td>点击</td>
<td><strong>onTap</strong></td>
<td>点击。</td>
</tr>
<tr>
<td><strong>onLongpress</strong></td>
<td>长按</td>
<td><strong>onLongTap</strong></td>
<td>长按 500ms 之后触发，触发了长按事件后进行移动将不会触发屏幕的滚动</td>
</tr>
<tr>
<td><strong>onAppear</strong></td>
<td>当前元素可见时触发</td>
<td><strong>onAppear</strong></td>
<td>当前元素可见面积超过 50%时触发</td>
</tr>
<tr>
<td><strong>onDisappear</strong></td>
<td>当前元素从可见变为不可见时触发</td>
<td><strong>onDisappear</strong></td>
<td>当前元素不可见面积超过 50%时触发</td>
</tr>
<tr>
<td><strong>onFirstAppear</strong></td>
<td>当前元素首次可见时触发</td>
<td><strong>onFirstAppear</strong></td>
<td>当前元素首次可见面积达到 50%时触发</td>
</tr>
<tr>
<td>onTouchStart</td>
<td>触摸动作开始</td>
<td>onTouchStart</td>
<td>触摸动作开始。</td>
</tr>
<tr>
<td>onTouchMove</td>
<td>触摸后移动</td>
<td>onTouchMove</td>
<td>触摸后移动。</td>
</tr>
<tr>
<td>onTouchEnd</td>
<td>触摸动作结束</td>
<td>onTouchEnd</td>
<td>触摸动作结束。</td>
</tr>
<tr>
<td>onTouchCancel</td>
<td>触摸动作被打断，如来电提醒，弹窗</td>
<td>onTouchCancel</td>
<td>触摸动作被打断，如来电提醒，弹窗</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>可以看到有 5 条 API 属性有不同，其中 3 条是使用方法不同，2 条是需要编译器处理的属性。</p>
<ul>
<li>onClick -&gt; onTap</li>
<li>onLongpress -&gt; onLongTap</li>
</ul>
<p>View 转换器的逻辑如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;@babel/types&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">transformViewElement</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 确保我们只处理具有 name 属性的 JSXElement
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">openingElement</span> <span class="o">&amp;&amp;</span> <span class="nx">path</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">openingElement</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">openingElementName</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">openingElement</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">t</span><span class="p">.</span><span class="nx">isJSXIdentifier</span><span class="p">(</span><span class="nx">openingElementName</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">openingElementName</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s2">&#34;View&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">path</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">openingElement</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">attribute</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">isJSXAttribute</span><span class="p">(</span><span class="nx">attribute</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="kr">const</span> <span class="nx">attributeName</span> <span class="o">=</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="k">switch</span> <span class="p">(</span><span class="nx">attributeName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s2">&#34;onClick&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">              <span class="nx">attribute</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">&#34;onTap&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s2">&#34;onLongpress&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">              <span class="nx">attribute</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">&#34;onLongTap&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">transformViewElement</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>跟之前操作差不多，还是遍历找节点，找到要处理的 API 属性，将属性重命名。
至此，我们实现了 Rax -&gt; Taro View 组件的编译转换。接下来需要对剩下的 6 个基础组件做同样操作，即可完成本期目标：
重复流程如下：</p>
<ol>
<li>列表格，整理 API 差异，标明处理方式</li>
<li>遍历 AST 找对应节点、找到需要处理的 API 属性</li>
<li>执行重命名 or 删除动作</li>
</ol>
<p>机械性动作 * n &hellip;</p>
<p>为了保证转换器的拓展性，这里新增了一个主入口 index.js 文件用来批量管理各个独立组建的小转换器。
<img src="https://cdn.nlark.com/yuque/0/2024/png/2019260/1709618204459-ba30c46b-a2e4-47be-8c6d-c433d60711a5.png#averageHue=%23282732&amp;clientId=u9be0d808-8907-4&amp;from=ui&amp;id=u490fd858&amp;originHeight=936&amp;originWidth=2064&amp;originalType=binary&amp;ratio=2&amp;rotation=0&amp;showTitle=false&amp;size=1072219&amp;status=done&amp;style=shadow&amp;taskId=uc7cf71ab-a36d-4a84-9944-a89f95080ad&amp;title=" alt="截屏2024-03-05 13.53.57.png"></p>
<p>其他组件的对应表请在语雀文档查看：
<a href="https://aliyuque.antfin.com/ljl353638/hy9yg3/xpgtgg3c8cv2wntt">https://aliyuque.antfin.com/ljl353638/hy9yg3/xpgtgg3c8cv2wntt</a></p>
<h1 id="四自动化测试">四、自动化测试</h1>
<p>由于在本地转换各个 API 需要反复调试，并且需要实时查看组件编译后的情况。为了开发提效，我本地还需要运行 Rax 和 Taro 两个用脚手架生成的项目，加一个小自动化测试脚本进行一键编译调试。</p>
<p>具体步骤如下，在<code>e2e.test.js</code> 中：</p>
<ul>
<li>设定 Rax 项目路径：本项目从 Rax 应用的源文件夹<code>rax-test-demo/src/index.js</code>读取待转换组件代码。</li>
<li>设定 Taro 项目路径：将转换后的 Taro 组件代码写入 Taro 应用的目标文件夹 <code>TaroTestDemo/src/app.js</code></li>
<li>转换代码：命令行执行：<code>npm run test:e2e</code> 转换器将源代码解析为 AST，并进行转换。</li>
<li>监测转换结果：在 Taro 测试环境中检查转换后的代码，确保没有报错且符合预期。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;fs&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;path&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span> <span class="nx">transform</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;../src/Transformers&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">parser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;@babel/parser&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">generator</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;@babel/generator&#34;</span><span class="p">).</span><span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 基于你 Rax 源文件和 Taro 输出的路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">raxSourcePath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s2">&#34;../../rax-test-demo/src/index.js&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">taroOutputPath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">__dirname</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;../../TaroTestDemo/src/pages/index/index.jsx&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">describe</span><span class="p">(</span><span class="s2">&#34;End-to-End Transformation&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">it</span><span class="p">(</span><span class="s2">&#34;从Rax组件中读取源码，转换为Taro组件&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">raxSourceCode</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">raxSourcePath</span><span class="p">,</span> <span class="s2">&#34;utf8&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 1.解析 Rax 源代码为 AST
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">raxAst</span> <span class="o">=</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">raxSourceCode</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">sourceType</span><span class="o">:</span> <span class="s2">&#34;module&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">plugins</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;jsx&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 2.转换 AST
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">transform</span><span class="p">(</span><span class="nx">raxAst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 3.生成转换后的 Taro 源代码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">taroOutput</span> <span class="o">=</span> <span class="nx">generator</span><span class="p">(</span><span class="nx">raxAst</span><span class="p">,</span> <span class="p">{});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">taroOutputPath</span><span class="p">,</span> <span class="nx">taroOutput</span><span class="p">.</span><span class="nx">code</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><h2 id="01--准备-rax-测试环境">01 | 准备 Rax 测试环境</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">npm install -g rax-cli <span class="c1"># 安装 Rax 脚手架（如果尚未安装）</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> Desktop <span class="c1"># 进入桌面</span>
</span></span><span class="line"><span class="cl">rax init RaxTestDemo <span class="c1"># 初始化 Rax 项目</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 进入文件夹</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> rax-test-demo
</span></span><span class="line"><span class="cl"><span class="c1"># 安装依赖</span>
</span></span><span class="line"><span class="cl">npm install
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 运行</span>
</span></span><span class="line"><span class="cl">npm start
</span></span></code></pre></div><p>脚手架选项如下：
<img src="https://cdn.nlark.com/yuque/0/2024/png/2019260/1709618822132-2be7baba-1ace-48f6-a01e-11c2b6edc111.png#averageHue=%23111111&amp;clientId=u9be0d808-8907-4&amp;from=ui&amp;id=u4cb01bbd&amp;originHeight=294&amp;originWidth=1626&amp;originalType=binary&amp;ratio=2&amp;rotation=0&amp;showTitle=false&amp;size=317538&amp;status=done&amp;style=shadow&amp;taskId=ueead23ea-f8a0-4fa9-a515-6a904a277a9&amp;title=" alt="截屏2024-03-05 14.06.44.png"></p>
<h2 id="02--准备-taro-测试环境">02 | 准备 Taro 测试环境</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">npm install -g @tarojs/cli <span class="c1"># 安装 Taro 脚手架（如果尚未安装）</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> Desktop <span class="c1"># 进入桌面</span>
</span></span><span class="line"><span class="cl">taro init TaroTestDemo <span class="c1"># 初始化 Taro 项目</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 进入文件夹</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> TaroTestDemo
</span></span><span class="line"><span class="cl"><span class="c1"># 安装依赖</span>
</span></span><span class="line"><span class="cl">npm install
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 运行</span>
</span></span><span class="line"><span class="cl">npm run dev:h5
</span></span></code></pre></div><p>脚手架选项如下：
<img src="https://cdn.nlark.com/yuque/0/2024/png/2019260/1709618893196-d72cf860-2e63-4285-b139-08a0f225fb6f.png#averageHue=%230a0a0a&amp;clientId=u9be0d808-8907-4&amp;from=ui&amp;id=u317a7a99&amp;originHeight=684&amp;originWidth=1588&amp;originalType=binary&amp;ratio=2&amp;rotation=0&amp;showTitle=false&amp;size=591533&amp;status=done&amp;style=shadow&amp;taskId=ub70b2783-1e89-4f5f-a2ca-02e55a04ac9&amp;title=" alt="截屏2024-03-05 14.07.56.png">
确保遵循上述步骤来准备 Rax 和 Taro 的测试环境。在双方都构建完成后，您可以执行 Jest 测试来验证转换过程。</p>
<h2 id="03--执行自动化测试">03 | 执行自动化测试</h2>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/2019260/1709618988413-80510d7b-ac96-4e29-879b-ff07bcb568e4.png#averageHue=%23272635&amp;clientId=u9be0d808-8907-4&amp;from=ui&amp;height=286&amp;id=u215c197d&amp;originHeight=556&amp;originWidth=972&amp;originalType=binary&amp;ratio=2&amp;rotation=0&amp;showTitle=false&amp;size=276700&amp;status=done&amp;style=shadow&amp;taskId=uf79f1139-e2b3-454f-955f-cd780cb7425&amp;title=&amp;width=500" alt="截屏2024-03-05 14.09.27.png"></p>
<ol>
<li>安装 <a href="https://jestjs.io/">Jest</a> 命令行执行：<code>npm install --save-dev jest</code></li>
<li>package.json 配置：<code>&quot;test:e2e&quot;: &quot;jest tests/e2e.test.js&quot;</code></li>
<li>命令行执行：<code>npm run test:e2e</code></li>
</ol>
<p>此时，你就可以在本地同时运行 Rax 与 Taro 项目，一边写 Rax 一边可实时通过此条命令进行编译转换 Taro。</p>
<h1 id="五总结">五、总结</h1>
<p>本篇文章从零开始构造了一个略具复杂度的 Rax 转 Taro 编译器。
初始目标挺吓人，但经过合理拆解发现大目标也不过只是走通 MVP（最小可行产品）后的重复累加。工作如此，生活亦如此。专注你的目标，不要被纷繁的信息流影响，脚踏实地一步步完成你的小 Step，一切总能完成的。</p>
<p>后续对这个编译器，我计划如下内容，欢迎持续关注：</p>
<ul>
<li><input disabled="" type="checkbox"> 新增自定义脚手架功能</li>
<li><input disabled="" type="checkbox"> 抹平转换过程中的 CSS 样式差异</li>
<li><input disabled="" type="checkbox"> 新增 README_EN 完善中英文使用文档</li>
</ul>
<p>写作不易，如果觉得本文对你有启发有帮助的话，请在 <a href="https://github.com/Trade-Offf/Rax2Taro?tab=readme-ov-file">GitHub</a> 帮我点个 Star ⭐
交个朋友，比心感谢 ❤ ~~~</p>

            </div>
        </article><hr style="margin-top: 40px; margin-bottom: 40px;" />
<div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "tradeofff" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://github.com/Trade-Offf/blog" target="_blank" rel="noopener noreferrer me"
    title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="https://twitter.com" target="_blank" rel="noopener noreferrer me"
    title="Twitter">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z">
    </path>
</svg>
</a>
<a href="/index.xml" target="_blank" rel="noopener noreferrer me"
    title="Rss">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>
</a>
</div>
    <small class="footer_copyright">
        © 2024 .
        
    </small>
</footer><a href="#" title="" id="totop">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" stroke="currentColor" viewBox="0 96 960 960">
    <path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197Z"/>
</svg>

</a>


    






    
    <script async src="http://localhost:1313/js/main.js" ></script>

    

</body>
</html>
